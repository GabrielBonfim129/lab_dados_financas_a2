---
title: "A1 - Lab. Dados Aplicado a Finanças"
author: "Gabriel Bonfim"
output:
  html_document: default
  pdf_document: default

---

```{r setup, message=FALSE, warning=FALSE}

#instalar todos os pacotes

pkgs <- c("tidyverse","lubridate","scales","TTR","yfR","fundamentus","gt","gtExtras","glue")

library(tidyverse)
library(lubridate)
library(scales)
library(TTR)
library(yfR)
library(gt)
library(gtExtras)
library(glue)
library(patchwork)


```

Serão analisados ativos de empresas do setor de energia. Para isso, foi escolhida uma amostra ampla de empresas do setor listadas na B3, que serão analisadas posteriormente através de dois métodos: MACD e RSI.


```{r companies, message=FALSE}

# Pool amplo do setor
candidate_tickers <- c(
  "ELET3","ELET6","EGIE3","EQTL3","TAEE11","TAEE3","TAEE4","NEOE3","ENBR3",
  "ENGI11","ENGI3","ENGI4","CPFE3","CPLE3","CPLE6","CMIG3","CMIG4","TRPL3",
  "TRPL4","ALUP11","ALUP3","ALUP4","AURE3","MEGA3","LIGT3","CLSC3","CLSC4",
  "CEBR3","CEBR5","CEBR6","COCE3","COCE5","RNEW3","RNEW4","RNEW11","ENEV3"
  )

min_obs <- 35  # mínimo de observações para calcular com conforto (26+9 ~ 35)

```

Com as empresas selecionadas, é possível utilizar a API do Yahoo Finance para extrair as informações necessárias para a análise técnica, conforme código comentado abaixo. 

Além disso, serão selecionadas apenas os ativos que possuírem observações suficientes para construção da análise, removendo ações pouco negociadas.


```{r download-and-select, message=FALSE, warning=FALSE}

# Locale e timezone "neutros" para evitar parsing ambíguo + escokha de datas

Sys.setlocale("LC_TIME", "C")
Sys.setenv(TZ = "UTC")

first_date <- as.Date(Sys.Date() - 365*2)  # últimos 2 anos
last_date  <- as.Date(Sys.Date())

# Edita tickers para serem reconhecidos pela API
tickers_yahoo_all <- paste0(candidate_tickers, ".SA")

# Função para baixar dados necessários e limpar dados
safe_yf_get <- function(tks, first_date, last_date) {
  out <- yfR::yf_get(
    tickers = tks,
    first_date = as.Date(first_date),
    last_date  = as.Date(last_date),
    do_cache = FALSE,
    thresh_bad_data = 0.60
  )
  # ref_date é Date mesmo se vier como character
  if (!inherits(out$ref_date, "Date")) {
    suppressWarnings({
      d1 <- as.Date(out$ref_date)
      d2 <- ifelse(is.na(d1), as.Date(out$ref_date, "%d/%m/%Y"), d1)
      d3 <- ifelse(is.na(d2), as.Date(out$ref_date, "%m/%d/%Y"), d2)
      out$ref_date <- as.Date(d3, origin = "1970-01-01")
    })
  }
  # remove linhas sem data válida ou preço
  out <- out |>
    dplyr::filter(!is.na(ref_date), !is.na(price_adjusted)) |>
    dplyr::arrange(ticker, ref_date)
  out
}

# Download
raw_prices <- tryCatch(
  safe_yf_get(tickers_yahoo_all, first_date, last_date),
  error = function(e) {
    message("Falha no yf_get: ", conditionMessage(e))
    tibble::tibble() # retorna vazio para não quebrar a knit
  }
)

# Checagem mínima
stopifnot(nrow(raw_prices) > 0)

# Mantém apenas tickers com amostra mínima (definida em min_obs)
valid_prices <- raw_prices |>
  dplyr::group_by(ticker) |>
  dplyr::filter(dplyr::n() >= min_obs) |>
  dplyr::ungroup()

# Todos os tickers válidos
valid_info <- valid_prices %>%
  dplyr::group_by(ticker) %>%
  dplyr::summarise(
    n = dplyr::n(),
    first = min(ref_date, na.rm=TRUE),
    last  = max(ref_date, na.rm=TRUE),
    .groups = "drop"
  ) %>% dplyr::arrange(dplyr::desc(n))

valid_all <- valid_info$ticker

# Data frame de preços apenas com os válidos
prices <- valid_prices %>%
  dplyr::filter(ticker %in% valid_all) %>%
  dplyr::select(ref_date, ticker, price_adjusted) %>%
  dplyr::arrange(ticker, ref_date)

# Tickers "limpos"
tickers_final <- gsub("\\.SA$", "", valid_all)
glue::glue("Selecionados {length(tickers_final)} tickers válidos: {paste(tickers_final, collapse = ', ')}")

```

Com a amostra selecionada e dados limpos, podemos realizar a análise técnica utilizando o MACD e RSI. Com isso, será atribuida uma pontuação para cada ativo baseando se nos critérios de ambos métodos.

```{r indicators, message=FALSE, warning=FALSE}

safe_calc_ind <- function(df){
  n <- nrow(df)
  px <- df$price_adjusted

  # Se poucos dados úteis, retorna NAs e flaga FALSE
  if (sum(is.finite(px)) < min_obs) {
    return(
      df %>%
        mutate(
          macd = NA_real_,
          macd_signal = NA_real_,
          macd_hist = NA_real_,
          rsi = NA_real_,
          macd_bull = FALSE,
          macd_cross_up = FALSE,
          rsi_ok = FALSE,
          rsi_rising = FALSE
        )
    )
  }

  # MACD
  macd_obj <- tryCatch(
    TTR::MACD(px, nFast = 12, nSlow = 26, nSig = 9, maType = "EMA"),
    error = function(e) NULL
  )

  # Coerção para data.frame com colunas garantidas
  macd_df <- if (is.null(macd_obj)) {
    data.frame(macd = rep(NA_real_, n), signal = rep(NA_real_, n))
  } else {
    md <- as.data.frame(macd_obj)
    if (!"macd" %in% names(md))    md$macd   <- NA_real_
    if (!"signal" %in% names(md))  md$signal <- NA_real_
    if (nrow(md) < n) md[(nrow(md)+1):n, c("macd","signal")] <- NA_real_
    md
  }

  # RSI
  rsi_vec <- tryCatch(TTR::RSI(px, n = 14), error = function(e) rep(NA_real_, n))
  if (length(rsi_vec) < n) rsi_vec <- c(rsi_vec, rep(NA_real_, n - length(rsi_vec)))

  out <- df %>%
    mutate(
      macd        = macd_df$macd,
      macd_signal = macd_df$signal,
      macd_hist   = macd - macd_signal,
      rsi         = rsi_vec
    ) %>%
    mutate(
      macd_bull     = if_else(is.finite(macd) & is.finite(macd_signal) & macd > macd_signal, TRUE, FALSE, FALSE),
      macd_cross_up = macd_bull & !lag(macd_bull, default = FALSE),
      rsi_ok        = if_else(is.finite(rsi) & rsi >= 30 & rsi <= 70, TRUE, FALSE, FALSE),
      rsi_rising    = if_else(is.finite(rsi) & is.finite(lag(rsi)), rsi > lag(rsi), FALSE)
    )

  out
}

prices_ind <- prices %>%
  group_by(ticker) %>%
  group_modify(~safe_calc_ind(.x)) %>%
  ungroup()

# Snapshot do último dia disponível por ticker
tech_latest <- prices_ind %>%
  group_by(ticker) %>%
  slice_max(order_by = ref_date, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  mutate(
    tech_score = rowMeans(cbind(macd > macd_signal, #atribui um score com base nos outputs do MACD e RSI na data
                                macd_hist > 0,
                                rsi >= 30 & rsi <= 70,
                                rsi > lag(rsi)), na.rm = TRUE)
  ) %>%
  select(ticker, ref_date, macd, macd_signal, macd_hist, rsi, tech_score)

```

Atribuindo essa pontuação, é possível verificar quais os 5 melhores ativos do pool de empresas do setor de energia, conforme tabela abaixo:

```{r ranking, message=FALSE}

rank_tbl <- tech_latest %>%
  mutate(
    Ticker = gsub("\\.SA$", "", ticker),
    Data   = as.character(ref_date)
  ) %>%
  arrange(desc(tech_score)) %>%
  select(
    Ticker, Data,
    MACD = macd,
    Sinal = macd_signal,
    Hist = macd_hist,
    RSI = rsi,
    `Score Técnico` = tech_score
  )

top5 <- rank_tbl %>% slice_head(n = 5)

# Tabela completa
gt::gt(rank_tbl) %>%
  gt::tab_header(
    title    = md("**Ranking Técnico – Energia Elétrica**"),
    subtitle = "MACD (12,26,9) + RSI(14); score = média de 4 sinais"
  ) %>%
  gtExtras::gt_hulk_col_numeric(columns = c(`Score Técnico`)) %>%
  gt::fmt_number(columns = c(MACD, Sinal, Hist, RSI, `Score Técnico`), decimals = 2) %>%
  gt::cols_align(align = "right", columns = where(is.numeric))

# Top 5 “compradas”
gt::gt(top5) %>%
  gt::tab_header(
    title    = md("**Top 5 — Sinal de Compra (Técnico)**"),
    subtitle = "Maior score técnico (MACD & RSI)"
  ) %>%
  gtExtras::gt_hulk_col_numeric(columns = c(`Score Técnico`)) %>%
  gt::fmt_number(columns = c(MACD, Sinal, Hist, RSI, `Score Técnico`), decimals = 2) %>%
  gt::cols_align(align = "right", columns = where(is.numeric))


```

Por fim, podemos plottar esses 5 ativos e verificar, graficamente, seu compartamento para ambos os métodos de análise.

```{r plots, fig.width=8, fig.height=4, message=FALSE, warning=FALSE}


plot_macd_rsi_pair <- function(tk_yahoo){
  df <- prices_ind %>% dplyr::filter(ticker == tk_yahoo)
  tk <- gsub("\\.SA$", "", tk_yahoo)

  # Fráfico MACD
  p_macd <- ggplot(df, aes(x = ref_date)) +
    geom_col(aes(y = macd_hist, fill = "Variação (Hist)"), alpha = 0.25, show.legend = TRUE) +
    geom_line(aes(y = macd, color = "MACD"), linewidth = 0.6) +
    geom_line(aes(y = macd_signal, color = "Linha de Sinal", linetype = "Linha de Sinal"), linewidth = 0.6) +
    labs(title = "MACS", x = NULL, y = "MACD") +
    guides(
      fill = guide_legend(title = NULL),
      color = guide_legend(title = NULL),
      linetype = guide_legend(title = NULL)
    ) +
    theme_minimal()

  # Gráfico RSI
  p_rsi <- ggplot(df, aes(x = ref_date)) +
    geom_line(aes(y = rsi, color = "RSI"), linewidth = 0.6, show.legend = TRUE) +
    geom_hline(aes(yintercept = 30, linetype = "Limites RSI (30/70)"), show.legend = TRUE) +
    geom_hline(aes(yintercept = 70, linetype = "Limites RSI (30/70)"), show.legend = TRUE) +
    labs(title = "RSI", x = NULL, y = "RSI") +
    guides(
      color = guide_legend(title = NULL),
      linetype = guide_legend(title = NULL)
    ) +
    theme_minimal()

  # Formatar gráficos
  (p_macd / p_rsi) +
    plot_annotation(
      title = tk,
      theme = theme(
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
      )
    )
}

# Printar para os 5 ativos escolhidos
tickers_plot <- paste0(top5$Ticker, ".SA")
for(tk in tickers_plot){
  print(plot_macd_rsi_pair(tk))
}



```

